# MyCad - 简易3D CAD软件

基于 OpenCascade 和 Qt 开发的简易 3D 建模软件，提供基本的 CAD 建模、编辑和可视化功能。

## 功能特性

### 文件操作
- ? **导入文件**：支持 STEP (.stp, .step), IGES (.igs, .iges), STL (.stl), OBJ (.obj), GLTF (.gltf), GLB (.glb)
- ? **导出文件**：支持 STEP, IGES, STL, OBJ, GLTF, GLB
- ? **保存文件**：序列化为自定义 .mycad 格式
- ? **打开文件**：反序列化 .mycad 文件

### 视图操作
- ? **视图基本操作**：
  - 鼠标中键滚轮：缩放视图
  - 鼠标中键拖动：旋转视图
  - 鼠标右键拖动：平移视图
- ? **视角变换**：顶视图、前视图、左视图、右视图、后视图、底视图、等轴测视图
- ? **ViewCube**：左下角显示 OpenCascade 内置的 ViewCube，支持鼠标交互快速切换视角
- ? **适应窗口**：一键适应所有对象到视图窗口

### 建模功能
- ? **基本体素建模**：
  - 方块（Box）
  - 圆柱（Cylinder）
  - 球（Sphere）
  - 圆锥（Cone）
- ? **拉伸**：待完善
- ? **扫略**：待完善

### 选择与编辑
- ? **选择过滤**：控制鼠标左键选择特定类型的几何元素
  - 无过滤（选择所有）
  - 顶点（Vertex）
  - 边（Edge）
  - 线（Wire）
  - 面（Face）
  - 壳（Shell）
  - 体（Solid）
  - 复合体（Compound）
- ? **选择方式**：
  - 鼠标左键点击：点选
  - 鼠标左键拖动：框选
  - Ctrl + 左键：多选/取消选择
- ? **右键菜单**（选中对象时）：
  - **参数**：显示对象的几何参数（体积、表面积、尺寸、质心等）
  - **颜色**：修改对象颜色
  - **透明度**：使用滑块调整对象透明度（0-1，实时预览）
  - **隐藏**：隐藏选中的对象
  - **仅显示**：隐藏其他对象，只显示选中的对象
  - **显示全部**：显示所有隐藏的对象
  - **隐藏全部**：隐藏所有对象
  - **清空**：删除所有对象
- ? **右键菜单**（未选中对象时）：
  - **显示全部**：显示所有隐藏的对象
  - **隐藏全部**：隐藏所有对象
  - **清空**：删除所有对象

### 布尔运算
- ? **并集**（Union）：合并多个对象
- ? **差集**（Cut）：从第一个对象中减去其他对象
- ? **交集**（Intersect）：保留多个对象的交集部分

### 变换操作
- ? **平移**：待完善
- ? **旋转**：待完善
- ? **镜像**：待完善
- ? **阵列**：待完善

### 其他功能
- ? **鼠标拾取**：在模型上点击创建点（待完善）

## 技术栈

- **C++17**：主要编程语言
- **Qt 5.15.2**：GUI 框架
- **OpenCascade 7.9.2**：3D CAD 内核
- **CMake 3.16+**：构建系统
- **Visual Studio 2022**：开发环境（Windows）

## 系统要求

- **操作系统**：Windows 10/11
- **编译器**：Visual Studio 2022（MSVC 2019/2022）
- **Qt**：5.15.2 (msvc2019_64)
- **OpenCascade**：7.9.2 (vc14-64)
- **CMake**：3.16 或更高版本

## 构建说明

### 1. 配置路径

编辑 `CMakeLists.txt`，确保以下路径正确：

```cmake
# OpenCascade路径
set(OCCT_DIR "F:/OpenCasCAD/opencascade-7.9.2/occt-vc14-64")

# Qt路径
set(Qt5_DIR "D:/Qt5.15.2/5.15.2/msvc2019_64/lib/cmake/Qt5")
```

根据你的实际安装路径修改这些路径。

### 2. 使用 CMake 生成项目

```bash
mkdir build
cd build
cmake .. -G "Visual Studio 17 2022" -A x64
```

### 3. 编译

**方式一：使用 Visual Studio**
- 打开生成的 `MyCad.sln` 解决方案文件
- 选择 Release 配置
- 生成解决方案（F7）

**方式二：使用命令行**
```bash
cmake --build . --config Release
```

### 4. 运行

编译完成后，可执行文件位于：
```
build/Release/MyCad.exe
```

或者使用项目根目录的 `run.bat` 脚本（如果已配置）。

## 项目结构

```
MyCad/
├── CMakeLists.txt          # CMake 配置文件
├── README.md               # 项目说明文档
├── build.bat               # 快速构建脚本
├── run.bat                 # 快速运行脚本
├── include/                # 头文件目录
│   ├── MainWindow.h        # 主窗口类
│   ├── View3D.h            # 3D 视图窗口类
│   ├── Document.h          # 文档管理类
│   ├── FileIO.h            # 文件导入导出类
│   ├── Modeling.h          # 建模功能类
│   ├── SelectionManager.h  # 选择管理器类
│   ├── TransformManager.h # 变换管理器类
│   └── EncodingHelper.h    # 编码辅助类
├── src/                    # 源文件目录
│   ├── main.cpp            # 程序入口
│   ├── MainWindow.cpp      # 主窗口实现
│   ├── View3D.cpp          # 3D 视图实现（包含鼠标交互、右键菜单等）
│   ├── Document.cpp        # 文档管理实现
│   ├── FileIO.cpp          # 文件 IO 实现
│   ├── Modeling.cpp        # 建模功能实现
│   ├── SelectionManager.cpp # 选择管理实现
│   └── TransformManager.cpp # 变换管理实现
└── resources/              # 资源文件目录
    └── resources.qrc       # Qt 资源文件
```

## 使用说明

### 基本操作

1. **创建基本体素**：
   - 通过菜单"建模"或工具栏创建方块、圆柱、球、圆锥
   - 创建后会自动适应视图

2. **视图操作**：
   - **缩放**：鼠标中键滚轮向上/向下滚动
   - **旋转**：按住鼠标中键拖动
   - **平移**：按住鼠标右键拖动
   - **快速切换视角**：点击左下角的 ViewCube 或使用工具栏按钮

3. **选择对象**：
   - **点选**：鼠标左键点击对象
   - **框选**：鼠标左键拖动框选多个对象
   - **多选**：Ctrl + 左键点击添加/移除选择
   - **选择过滤**：在右侧面板选择过滤类型，限制只能选择特定类型的几何元素

4. **布尔运算**：
   - 选择两个或多个对象
   - 使用"编辑"菜单中的"并集"、"差集"或"交集"
   - 原始对象会被删除，只保留运算结果

5. **对象属性编辑**：
   - 右键点击选中的对象
   - 选择"颜色"修改对象颜色
   - 选择"透明度"使用滑块调整透明度（0 为不透明，1 为完全透明）
   - 选择"参数"查看对象的几何参数

6. **对象显示控制**：
   - 右键菜单中的"隐藏"、"仅显示"、"显示全部"、"隐藏全部"
   - 用于管理复杂场景中的对象可见性

7. **导入/导出**：
   - 使用"文件"菜单导入或导出 3D 模型文件
   - 支持多种标准格式（STEP, IGES, STL 等）

### 选择过滤

在右侧面板的"选择过滤"下拉框中选择过滤类型：
- **无过滤**：可以选择所有类型的几何元素
- **顶点**：只能选择顶点
- **边**：只能选择边（提高像素容差，便于精确选择）
- **面**：只能选择面
- **体**：只能选择实体

选择过滤会应用到所有当前和后续添加的对象。

### 性能优化

- 鼠标移动探测使用节流机制（约 60fps），提高响应速度
- 像素容差设置为 8 像素，提高边和顶点的探测精度
- 使用 `RedrawImmediate()` 优化视图更新性能

## 开发状态

### ? 已完成
- 基础框架和架构
- 文件 IO（导入/导出/保存/打开）
- 基本体素建模（方块、圆柱、球、圆锥）
- 视图操作（平移、旋转、缩放、视角变换）
- ViewCube 集成
- 选择系统（点选、框选、多选）
- 选择过滤（点、边、面、体等）
- 布尔运算（并集、差集、交集）
- 右键菜单（参数、颜色、透明度、显示控制）
- 对象属性编辑（颜色、透明度）
- 对象显示控制（隐藏、显示、清空）

### ? 进行中/待完善
- 拉伸操作
- 扫略操作
- 变换操作（平移、旋转、镜像、阵列）
- 鼠标拾取点功能

### ? 计划中
- 更多建模工具（圆角、倒角、抽壳等）
- 渲染优化（材质、光照）
- 性能优化（大型模型处理）
- 撤销/重做功能
- 图层管理
- 测量工具

## 已知问题

- OBJ、GLTF、GLB 格式的导入导出功能需要额外的库支持，当前版本可能无法完全支持
- 某些复杂模型的布尔运算可能需要较长时间
- 建议使用 Release 模式编译以获得更好的性能

## 技术细节

### 鼠标交互优化
- **像素容差**：设置为 8 像素，提高边和顶点的探测精度
- **更新节流**：鼠标移动时限制更新频率到约 60fps，避免过度重绘
- **选择模式**：使用 OpenCascade 的 `AIS_Shape::SelectionType()` 方法设置选择模式

### 右键菜单实现
- 使用延迟执行机制，确保菜单完全关闭后再执行操作
- 根据选择状态动态显示菜单项
- 透明度调整使用滑块和数值输入框，支持实时预览

### 布尔运算
- 运算后自动删除原始对象
- 使用 OpenCascade 的 `BRepAlgoAPI_Fuse`、`BRepAlgoAPI_Cut`、`BRepAlgoAPI_Common` 实现

## 许可证

本项目仅供学习和研究使用。

## 贡献

欢迎提交 Issue 和 Pull Request！

## 更新日志

### v1.0.0
- 初始版本
- 实现基本的 CAD 功能
- 支持文件导入导出
- 实现基本体素建模
- 实现选择过滤和布尔运算
- 实现右键菜单和对象属性编辑
- 优化鼠标交互和探测精度
